<!doctype html> <html lang="en"> <head> <meta charset="utf-8"> <meta http-equiv="X-UA-Compatible" content="IE=edge"> <meta name="viewport" content="width=device-width, initial-scale=1"> <title>Predicting DC's bikeshare demand</title> <meta name="author" content="Brendan Sudol"> <meta name="keywords" content=""> <meta property="og:locale" content="en_US"> <meta property="og:type" content="article"> <meta property="og:title" content="Predicting DC's bikeshare demand"> <meta property="og:description" content="Predicting DC's bikeshare demand"> <meta property="og:url" content="https://www.brendansudol.com/writing/kaggle-bikeshare"> <meta property="og:site_name" content="Brendan Sudol"> <meta name="twitter:card" content="summary"> <meta name="twitter:site" content="@"> <meta name="twitter:title" content="Predicting DC's bikeshare demand"> <meta name="twitter:description" content="Predicting DC's bikeshare demand"> <meta name="twitter:url" content="https://www.brendansudol.com/writing/kaggle-bikeshare"> <meta name="twitter:image" content="https://www.brendansudol.com/assets/img/misc/bren-doodle-color.png"> <link rel="stylesheet" href="/assets/css/all.css?201712281825"> </head> <body class='site'> <div class='site-wrap'> <header class='container mx-auto px2 py3 mt1 mb2'> <a href='/' class='h3 bold black'>Brendan Sudol</a> <nav class='mt-tiny h5'> <a class='mr2 black' href='/writing/'>Writing</a> <a class='mr2 black' href='/projects/'>Projects</a> <a class='mr2 black' href='https://github.com/brendansudol'>Github</a> <a class='black' href='https://twitter.com/brensudol'>Twitter</a> </nav> </header> <div class='container mx-auto pl2 pr2'><div class='h6 gray'>May 2015</div> <h1 class='mt0 mb3 h2 sm-h0'>Predicting DC's bikeshare demand</h1> <article class='mb3 sm-col-4'><p>Recently, I’ve been doing some Kaggle competitions in my spare time and then sharing my approach / solution on here. <a href="http://www.brendansudol.com/posts/kaggle-titanic/">Last week</a>, I did a binary classification task around predicting Titanic survivors. In this second installment, let’s dive into a regression problem, <a href="https://www.kaggle.com/c/bike-sharing-demand">Bike Sharing Demand</a>.</p> <p>The problem involves Washington D.C.’s <a href="http://www.capitalbikeshare.com/system-data">bike sharing program</a>. The goal is to forecast hourly demand based on historical usage patterns and weather data. We’re given a dataset that’s complete for the first 19 days of every month (over a 2 year period), and we need to predict how many bikes are rented by hour for the remaining days of each month.</p> <p>There are several interesting pieces to this problem that can collectively help you arrive at a good model and result (top 5% of entries as of this post):</p> <ul> <li>There’s a timestamp column in the dataset that can be parsed to create several different time related variables (hour, day of the week, month, year, etc.) that are useful in modeling the intraday &amp; seasonal trends.</li> <li>In the training data, rentals are broken out into two groups of users (registered and casual), and these groups exhibit different usage patterns (e.g., see day of week chart below). Because of this, it seems to be beneficial to regress demand for these users separately and then combine the results together.</li> <li>Try applying some data transformations of your dependent variables to better account for their skewed distributions (e.g., note the mass of values bunched at the low end of the ‘casual’ histogram).</li> <li>After landing on a suitable feature set, take some time to optimize your model parameters; even simple (non-comprehensive) tuning can dramatically improve your score in this challenge.</li> </ul> <p>Enough with the chit chat, here’s the code (github repo <a href="https://github.com/brendansudol/kaggle-bike-share">here</a>):</p> <figure class="highlight"><pre><code class="language-python" data-lang="python"><span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="n">pd</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="n">np</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="n">plt</span>
<span class="kn">import</span> <span class="nn">seaborn</span> <span class="k">as</span> <span class="n">sns</span>
<span class="kn">from</span> <span class="nn">sklearn.ensemble</span> <span class="kn">import</span> <span class="n">RandomForestRegressor</span></code></pre></figure> <figure class="highlight"><pre><code class="language-python" data-lang="python"><span class="n">pd</span><span class="o">.</span><span class="n">set_option</span><span class="p">(</span><span class="s">'display.width'</span><span class="p">,</span> <span class="mi">500</span><span class="p">)</span>
<span class="n">pd</span><span class="o">.</span><span class="n">set_option</span><span class="p">(</span><span class="s">'display.max_columns'</span><span class="p">,</span> <span class="mi">30</span><span class="p">)</span>

<span class="n">sns</span><span class="o">.</span><span class="n">set_style</span><span class="p">(</span><span class="s">"darkgrid"</span><span class="p">)</span>
<span class="n">sns</span><span class="o">.</span><span class="n">set_context</span><span class="p">(</span><span class="n">rc</span><span class="o">=</span><span class="p">{</span><span class="s">"figure.figsize"</span><span class="p">:</span> <span class="p">(</span><span class="mi">6</span><span class="p">,</span> <span class="mi">3</span><span class="p">)})</span></code></pre></figure> <figure class="highlight"><pre><code class="language-python" data-lang="python"><span class="n">dfs</span> <span class="o">=</span> <span class="p">{}</span>
<span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="p">[</span><span class="s">'train'</span><span class="p">,</span> <span class="s">'test'</span><span class="p">]:</span>
    <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="s">'../data/</span><span class="si">%</span><span class="s">s.csv'</span> <span class="o">%</span> <span class="n">name</span><span class="p">)</span>
    <span class="n">df</span><span class="p">[</span><span class="s">'_data'</span><span class="p">]</span> <span class="o">=</span> <span class="n">name</span>
    <span class="n">dfs</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span>

<span class="c"># combine train and test data into one df</span>
<span class="n">df</span> <span class="o">=</span> <span class="n">dfs</span><span class="p">[</span><span class="s">'train'</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">dfs</span><span class="p">[</span><span class="s">'test'</span><span class="p">])</span>

<span class="c"># lowercase column names</span>
<span class="n">df</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="nb">map</span><span class="p">(</span><span class="nb">str</span><span class="o">.</span><span class="n">lower</span><span class="p">,</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">)</span>

<span class="n">df</span><span class="o">.</span><span class="n">head</span><span class="p">()</span></code></pre></figure> <div class="html-output"> <div style="max-height:1000px;max-width:1500px;overflow:auto;"> <table border="1" class="dataframe"> <thead> <tr style="text-align: right;"> <th></th> <th>_data</th> <th>atemp</th> <th>casual</th> <th>count</th> <th>datetime</th> <th>holiday</th> <th>humidity</th> <th>registered</th> <th>season</th> <th>temp</th> <th>weather</th> <th>windspeed</th> <th>workingday</th> </tr> </thead> <tbody> <tr> <th>0</th> <td> train</td> <td> 14.395</td> <td> 3</td> <td> 16</td> <td> 2011-01-01 00:00:00</td> <td> 0</td> <td> 81</td> <td> 13</td> <td> 1</td> <td> 9.84</td> <td> 1</td> <td> 0</td> <td> 0</td> </tr> <tr> <th>1</th> <td> train</td> <td> 13.635</td> <td> 8</td> <td> 40</td> <td> 2011-01-01 01:00:00</td> <td> 0</td> <td> 80</td> <td> 32</td> <td> 1</td> <td> 9.02</td> <td> 1</td> <td> 0</td> <td> 0</td> </tr> <tr> <th>2</th> <td> train</td> <td> 13.635</td> <td> 5</td> <td> 32</td> <td> 2011-01-01 02:00:00</td> <td> 0</td> <td> 80</td> <td> 27</td> <td> 1</td> <td> 9.02</td> <td> 1</td> <td> 0</td> <td> 0</td> </tr> <tr> <th>3</th> <td> train</td> <td> 14.395</td> <td> 3</td> <td> 13</td> <td> 2011-01-01 03:00:00</td> <td> 0</td> <td> 75</td> <td> 10</td> <td> 1</td> <td> 9.84</td> <td> 1</td> <td> 0</td> <td> 0</td> </tr> <tr> <th>4</th> <td> train</td> <td> 14.395</td> <td> 0</td> <td> 1</td> <td> 2011-01-01 04:00:00</td> <td> 0</td> <td> 75</td> <td> 1</td> <td> 1</td> <td> 9.84</td> <td> 1</td> <td> 0</td> <td> 0</td> </tr> </tbody> </table> </div> </div> <figure class="highlight"><pre><code class="language-python" data-lang="python"><span class="c"># parse datetime colum &amp; add new time related columns</span>
<span class="n">dt</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DatetimeIndex</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s">'datetime'</span><span class="p">])</span>

<span class="n">df</span><span class="p">[</span><span class="s">'date'</span><span class="p">]</span> <span class="o">=</span> <span class="n">dt</span><span class="o">.</span><span class="n">date</span>
<span class="n">df</span><span class="p">[</span><span class="s">'day'</span><span class="p">]</span> <span class="o">=</span> <span class="n">dt</span><span class="o">.</span><span class="n">day</span>
<span class="n">df</span><span class="p">[</span><span class="s">'month'</span><span class="p">]</span> <span class="o">=</span> <span class="n">dt</span><span class="o">.</span><span class="n">month</span>
<span class="n">df</span><span class="p">[</span><span class="s">'year'</span><span class="p">]</span> <span class="o">=</span> <span class="n">dt</span><span class="o">.</span><span class="n">year</span>
<span class="n">df</span><span class="p">[</span><span class="s">'hour'</span><span class="p">]</span> <span class="o">=</span> <span class="n">dt</span><span class="o">.</span><span class="n">hour</span>
<span class="n">df</span><span class="p">[</span><span class="s">'dow'</span><span class="p">]</span> <span class="o">=</span> <span class="n">dt</span><span class="o">.</span><span class="n">dayofweek</span>
<span class="n">df</span><span class="p">[</span><span class="s">'woy'</span><span class="p">]</span> <span class="o">=</span> <span class="n">dt</span><span class="o">.</span><span class="n">weekofyear</span>
<span class="n">df</span><span class="p">[</span><span class="s">'weeks_since_start'</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">dt</span> <span class="o">-</span> <span class="nb">min</span><span class="p">(</span><span class="n">dt</span><span class="p">))</span><span class="o">.</span><span class="n">days</span> <span class="o">/</span> <span class="mi">7</span>

<span class="c"># logarithmic transformation of dependent cols</span>
<span class="c"># (adding 1 first so that 0 values don't become -inf)</span>
<span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="p">[</span><span class="s">'casual'</span><span class="p">,</span> <span class="s">'registered'</span><span class="p">,</span> <span class="s">'count'</span><span class="p">]:</span>
    <span class="n">df</span><span class="p">[</span><span class="s">'</span><span class="si">%</span><span class="s">s_log'</span> <span class="o">%</span> <span class="n">col</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="n">col</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>

<span class="n">df</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span></code></pre></figure> <div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>_data                              train
atemp                             14.395
casual                                 3
count                                 16
datetime             2011-01-01 00:00:00
holiday                                0
humidity                              81
registered                            13
season                                 1
temp                                9.84
weather                                1
windspeed                              0
workingday                             0
date                          2011-01-01
day                                    1
month                                  1
year                                2011
hour                                   0
dow                                    5
doy                                    1
woy                                   52
weeks_since_start                      0
casual_log                      1.386294
registered_log                  2.639057
count_log                       2.833213
Name: 0, dtype: object
</code></pre></div></div> <figure class="highlight"><pre><code class="language-python" data-lang="python"><span class="c"># let's plot some stuff to get a feel for the data</span>

<span class="c"># get training data</span>
<span class="n">dg</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">df</span><span class="p">[</span><span class="s">'_data'</span><span class="p">]</span> <span class="o">==</span> <span class="s">'train'</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

<span class="c"># distribution of casual / registered rentals by day</span>
<span class="n">by_day</span> <span class="o">=</span> <span class="n">dg</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s">'date'</span><span class="p">)[[</span><span class="s">'casual'</span><span class="p">,</span> <span class="s">'registered'</span><span class="p">]]</span><span class="o">.</span><span class="n">agg</span><span class="p">(</span><span class="nb">sum</span><span class="p">)</span>

<span class="k">print</span> <span class="n">by_day</span><span class="o">.</span><span class="n">describe</span><span class="p">()</span>

<span class="n">by_day</span><span class="o">.</span><span class="n">hist</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">3</span><span class="p">));</span></code></pre></figure> <div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>            casual   registered
count   456.000000   456.000000
mean    859.945175  3713.467105
std     698.913571  1494.477105
min       9.000000   491.000000
25%     318.000000  2696.000000
50%     722.000000  3700.000000
75%    1141.750000  4814.250000
max    3410.000000  6911.000000
</code></pre></div></div> <p><img src="/notebooks/md/bikeshare_files/bikeshare_5_1.png" alt="png" /></p> <figure class="highlight"><pre><code class="language-python" data-lang="python"><span class="c"># total rentals by month &amp; year</span>
<span class="n">dg</span><span class="o">.</span><span class="n">groupby</span><span class="p">([</span><span class="s">'year'</span><span class="p">,</span> <span class="s">'month'</span><span class="p">])[</span><span class="s">'count'</span><span class="p">]</span><span class="o">.</span><span class="n">agg</span><span class="p">(</span><span class="nb">sum</span><span class="p">)</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">kind</span><span class="o">=</span><span class="s">'bar'</span><span class="p">);</span></code></pre></figure> <p><img src="/notebooks/md/bikeshare_files/bikeshare_6_0.png" alt="png" /></p> <figure class="highlight"><pre><code class="language-python" data-lang="python"><span class="c"># casual / registered rentals by day of the week</span>
<span class="n">by_dow</span> <span class="o">=</span> <span class="n">dg</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s">'dow'</span><span class="p">)[[</span><span class="s">'casual'</span><span class="p">,</span> <span class="s">'registered'</span><span class="p">]]</span><span class="o">.</span><span class="n">agg</span><span class="p">(</span><span class="nb">sum</span><span class="p">)</span>

<span class="n">by_dow</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">kind</span><span class="o">=</span><span class="s">'bar'</span><span class="p">,</span> <span class="n">width</span><span class="o">=</span><span class="mf">0.8</span><span class="p">);</span></code></pre></figure> <p><img src="/notebooks/md/bikeshare_files/bikeshare_7_0.png" alt="png" /></p> <figure class="highlight"><pre><code class="language-python" data-lang="python"><span class="c"># rentals by hour, split by working day (or not)</span>
<span class="n">by_hour</span> <span class="o">=</span> <span class="n">dg</span><span class="o">.</span><span class="n">groupby</span><span class="p">([</span><span class="s">'hour'</span><span class="p">,</span> <span class="s">'workingday'</span><span class="p">])[</span><span class="s">'count'</span><span class="p">]</span><span class="o">.</span><span class="n">agg</span><span class="p">(</span><span class="s">'sum'</span><span class="p">)</span><span class="o">.</span><span class="n">unstack</span><span class="p">()</span>

<span class="n">by_hour</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">kind</span><span class="o">=</span><span class="s">'bar'</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span><span class="mi">4</span><span class="p">),</span> <span class="n">width</span><span class="o">=</span><span class="mf">0.8</span><span class="p">);</span></code></pre></figure> <p><img src="/notebooks/md/bikeshare_files/bikeshare_8_0.png" alt="png" /></p> <figure class="highlight"><pre><code class="language-python" data-lang="python"><span class="c"># avg hourly rentals by temperature</span>
<span class="n">dg</span><span class="p">[</span><span class="s">'temp_int'</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="nb">round</span><span class="p">(</span><span class="n">dg</span><span class="p">[</span><span class="s">'temp'</span><span class="p">])</span>

<span class="n">dg</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s">'temp_int'</span><span class="p">)[</span><span class="s">'count'</span><span class="p">]</span><span class="o">.</span><span class="n">agg</span><span class="p">(</span><span class="s">'median'</span><span class="p">)</span><span class="o">.</span><span class="n">plot</span><span class="p">();</span></code></pre></figure> <p><img src="/notebooks/md/bikeshare_files/bikeshare_9_0.png" alt="png" /></p> <figure class="highlight"><pre><code class="language-python" data-lang="python"><span class="c"># correlation matrix</span>
<span class="n">cols</span> <span class="o">=</span> <span class="p">[</span>
    <span class="s">'count'</span><span class="p">,</span> <span class="s">'casual'</span><span class="p">,</span> <span class="s">'registered'</span><span class="p">,</span>
    <span class="s">'weather'</span><span class="p">,</span> <span class="s">'temp'</span><span class="p">,</span> <span class="s">'atemp'</span><span class="p">,</span> <span class="s">'humidity'</span><span class="p">,</span> <span class="s">'windspeed'</span><span class="p">,</span>
    <span class="s">'holiday'</span><span class="p">,</span> <span class="s">'workingday'</span><span class="p">,</span> <span class="s">'season'</span><span class="p">,</span> 
    <span class="s">'day'</span><span class="p">,</span> <span class="s">'month'</span><span class="p">,</span> <span class="s">'year'</span><span class="p">,</span> <span class="s">'hour'</span><span class="p">,</span> <span class="s">'dow'</span><span class="p">,</span> <span class="s">'woy'</span><span class="p">,</span>
<span class="p">]</span>

<span class="n">dg</span><span class="p">[</span><span class="n">cols</span><span class="p">]</span><span class="o">.</span><span class="n">corr</span><span class="p">()</span></code></pre></figure> <div class="html-output"> <div style="max-height:1000px;max-width:1500px;overflow:auto;"> <table border="1" class="dataframe"> <thead> <tr style="text-align: right;"> <th></th> <th>count</th> <th>casual</th> <th>registered</th> <th>weather</th> <th>temp</th> <th>atemp</th> <th>humidity</th> <th>windspeed</th> <th>holiday</th> <th>workingday</th> <th>season</th> <th>day</th> <th>month</th> <th>year</th> <th>hour</th> <th>dow</th> <th>doy</th> <th>woy</th> </tr> </thead> <tbody> <tr> <th>count</th> <td> 1.000000</td> <td> 0.690414</td> <td> 0.970948</td> <td>-0.128655</td> <td> 0.394454</td> <td> 0.389784</td> <td>-0.317371</td> <td> 0.101369</td> <td>-0.005393</td> <td> 0.011594</td> <td> 0.163439</td> <td> 0.019826</td> <td> 0.166862</td> <td> 0.260403</td> <td> 0.400601</td> <td>-0.002283</td> <td> 0.168056</td> <td> 0.152512</td> </tr> <tr> <th>casual</th> <td> 0.690414</td> <td> 1.000000</td> <td> 0.497250</td> <td>-0.135918</td> <td> 0.467097</td> <td> 0.462067</td> <td>-0.348187</td> <td> 0.092276</td> <td> 0.043799</td> <td>-0.319111</td> <td> 0.096758</td> <td> 0.014109</td> <td> 0.092722</td> <td> 0.145241</td> <td> 0.302045</td> <td> 0.246959</td> <td> 0.092957</td> <td> 0.079906</td> </tr> <tr> <th>registered</th> <td> 0.970948</td> <td> 0.497250</td> <td> 1.000000</td> <td>-0.109340</td> <td> 0.318571</td> <td> 0.314635</td> <td>-0.265458</td> <td> 0.091052</td> <td>-0.020956</td> <td> 0.119460</td> <td> 0.164011</td> <td> 0.019111</td> <td> 0.169451</td> <td> 0.264265</td> <td> 0.380540</td> <td>-0.084427</td> <td> 0.170805</td> <td> 0.156480</td> </tr> <tr> <th>weather</th> <td>-0.128655</td> <td>-0.135918</td> <td>-0.109340</td> <td> 1.000000</td> <td>-0.055035</td> <td>-0.055376</td> <td> 0.406244</td> <td> 0.007261</td> <td>-0.007074</td> <td> 0.033772</td> <td> 0.008879</td> <td>-0.007890</td> <td> 0.012144</td> <td>-0.012548</td> <td>-0.022740</td> <td>-0.047692</td> <td> 0.011746</td> <td> 0.019762</td> </tr> <tr> <th>temp</th> <td> 0.394454</td> <td> 0.467097</td> <td> 0.318571</td> <td>-0.055035</td> <td> 1.000000</td> <td> 0.984948</td> <td>-0.064949</td> <td>-0.017852</td> <td> 0.000295</td> <td> 0.029966</td> <td> 0.258689</td> <td> 0.015551</td> <td> 0.257589</td> <td> 0.061226</td> <td> 0.145430</td> <td>-0.038466</td> <td> 0.255887</td> <td> 0.240794</td> </tr> <tr> <th>atemp</th> <td> 0.389784</td> <td> 0.462067</td> <td> 0.314635</td> <td>-0.055376</td> <td> 0.984948</td> <td> 1.000000</td> <td>-0.043536</td> <td>-0.057473</td> <td>-0.005215</td> <td> 0.024660</td> <td> 0.264744</td> <td> 0.011866</td> <td> 0.264173</td> <td> 0.058540</td> <td> 0.140343</td> <td>-0.040235</td> <td> 0.262245</td> <td> 0.248653</td> </tr> <tr> <th>humidity</th> <td>-0.317371</td> <td>-0.348187</td> <td>-0.265458</td> <td> 0.406244</td> <td>-0.064949</td> <td>-0.043536</td> <td> 1.000000</td> <td>-0.318607</td> <td> 0.001929</td> <td>-0.010880</td> <td> 0.190610</td> <td>-0.011335</td> <td> 0.204537</td> <td>-0.078606</td> <td>-0.278011</td> <td>-0.026507</td> <td> 0.203155</td> <td> 0.216435</td> </tr> <tr> <th>windspeed</th> <td> 0.101369</td> <td> 0.092276</td> <td> 0.091052</td> <td> 0.007261</td> <td>-0.017852</td> <td>-0.057473</td> <td>-0.318607</td> <td> 1.000000</td> <td> 0.008409</td> <td> 0.013373</td> <td>-0.147121</td> <td> 0.036157</td> <td>-0.150192</td> <td>-0.015221</td> <td> 0.146631</td> <td>-0.024804</td> <td>-0.148062</td> <td>-0.145962</td> </tr> <tr> <th>holiday</th> <td>-0.005393</td> <td> 0.043799</td> <td>-0.020956</td> <td>-0.007074</td> <td> 0.000295</td> <td>-0.005215</td> <td> 0.001929</td> <td> 0.008409</td> <td> 1.000000</td> <td>-0.250491</td> <td> 0.029368</td> <td>-0.015877</td> <td> 0.001731</td> <td> 0.012021</td> <td>-0.000354</td> <td>-0.191832</td> <td> 0.001134</td> <td> 0.000976</td> </tr> <tr> <th>workingday</th> <td> 0.011594</td> <td>-0.319111</td> <td> 0.119460</td> <td> 0.033772</td> <td> 0.029966</td> <td> 0.024660</td> <td>-0.010880</td> <td> 0.013373</td> <td>-0.250491</td> <td> 1.000000</td> <td>-0.008126</td> <td> 0.009829</td> <td>-0.003394</td> <td>-0.002482</td> <td> 0.002780</td> <td>-0.704267</td> <td>-0.003024</td> <td>-0.022593</td> </tr> <tr> <th>season</th> <td> 0.163439</td> <td> 0.096758</td> <td> 0.164011</td> <td> 0.008879</td> <td> 0.258689</td> <td> 0.264744</td> <td> 0.190610</td> <td>-0.147121</td> <td> 0.029368</td> <td>-0.008126</td> <td> 1.000000</td> <td> 0.001729</td> <td> 0.971524</td> <td>-0.004797</td> <td>-0.006546</td> <td>-0.010553</td> <td> 0.970196</td> <td> 0.939284</td> </tr> <tr> <th>day</th> <td> 0.019826</td> <td> 0.014109</td> <td> 0.019111</td> <td>-0.007890</td> <td> 0.015551</td> <td> 0.011866</td> <td>-0.011335</td> <td> 0.036157</td> <td>-0.015877</td> <td> 0.009829</td> <td> 0.001729</td> <td> 1.000000</td> <td> 0.001974</td> <td> 0.001800</td> <td> 0.001132</td> <td>-0.011070</td> <td> 0.054102</td> <td> 0.018538</td> </tr> <tr> <th>month</th> <td> 0.166862</td> <td> 0.092722</td> <td> 0.169451</td> <td> 0.012144</td> <td> 0.257589</td> <td> 0.264173</td> <td> 0.204537</td> <td>-0.150192</td> <td> 0.001731</td> <td>-0.003394</td> <td> 0.971524</td> <td> 0.001974</td> <td> 1.000000</td> <td>-0.004932</td> <td>-0.006818</td> <td>-0.002266</td> <td> 0.998616</td> <td> 0.961809</td> </tr> <tr> <th>year</th> <td> 0.260403</td> <td> 0.145241</td> <td> 0.264265</td> <td>-0.012548</td> <td> 0.061226</td> <td> 0.058540</td> <td>-0.078606</td> <td>-0.015221</td> <td> 0.012021</td> <td>-0.002482</td> <td>-0.004797</td> <td> 0.001800</td> <td>-0.004932</td> <td> 1.000000</td> <td>-0.004234</td> <td>-0.003785</td> <td>-0.000837</td> <td>-0.003411</td> </tr> <tr> <th>hour</th> <td> 0.400601</td> <td> 0.302045</td> <td> 0.380540</td> <td>-0.022740</td> <td> 0.145430</td> <td> 0.140343</td> <td>-0.278011</td> <td> 0.146631</td> <td>-0.000354</td> <td> 0.002780</td> <td>-0.006546</td> <td> 0.001132</td> <td>-0.006818</td> <td>-0.004234</td> <td> 1.000000</td> <td>-0.002925</td> <td>-0.006735</td> <td>-0.006532</td> </tr> <tr> <th>dow</th> <td>-0.002283</td> <td> 0.246959</td> <td>-0.084427</td> <td>-0.047692</td> <td>-0.038466</td> <td>-0.040235</td> <td>-0.026507</td> <td>-0.024804</td> <td>-0.191832</td> <td>-0.704267</td> <td>-0.010553</td> <td>-0.011070</td> <td>-0.002266</td> <td>-0.003785</td> <td>-0.002925</td> <td> 1.000000</td> <td>-0.002786</td> <td> 0.007964</td> </tr> <tr> <th>doy</th> <td> 0.168056</td> <td> 0.092957</td> <td> 0.170805</td> <td> 0.011746</td> <td> 0.255887</td> <td> 0.262245</td> <td> 0.203155</td> <td>-0.148062</td> <td> 0.001134</td> <td>-0.003024</td> <td> 0.970196</td> <td> 0.054102</td> <td> 0.998616</td> <td>-0.000837</td> <td>-0.006735</td> <td>-0.002786</td> <td> 1.000000</td> <td> 0.961538</td> </tr> <tr> <th>woy</th> <td> 0.152512</td> <td> 0.079906</td> <td> 0.156480</td> <td> 0.019762</td> <td> 0.240794</td> <td> 0.248653</td> <td> 0.216435</td> <td>-0.145962</td> <td> 0.000976</td> <td>-0.022593</td> <td> 0.939284</td> <td> 0.018538</td> <td> 0.961809</td> <td>-0.003411</td> <td>-0.006532</td> <td> 0.007964</td> <td> 0.961538</td> <td> 1.000000</td> </tr> </tbody> </table> </div> </div> <figure class="highlight"><pre><code class="language-python" data-lang="python"><span class="c"># instead of randomly splitting our training data </span>
<span class="c"># for cross validation, let's construct a framework that's more</span>
<span class="c"># in line with how the data is divvied up for this competition</span>
<span class="c"># (given first 19 days of each month, what is demand for remaining days)</span>
<span class="c"># so, let's split our training data into 2 time contiguous datasets</span>
<span class="c"># for fitting and validating our model (days 1-14 vs. days 15-19).</span>

<span class="c"># also, since submissions are evaluated based on the</span>
<span class="c"># root mean squared logarithmic error (RMSLE), let's replicate</span>
<span class="c"># that computation as we test and tune our model.</span>

<span class="k">def</span> <span class="nf">get_rmsle</span><span class="p">(</span><span class="n">y_pred</span><span class="p">,</span> <span class="n">y_actual</span><span class="p">):</span>
    <span class="n">diff</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">y_pred</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">y_actual</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
    <span class="n">mean_error</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">square</span><span class="p">(</span><span class="n">diff</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">mean_error</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">get_data</span><span class="p">():</span>
    <span class="n">data</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">df</span><span class="p">[</span><span class="s">'_data'</span><span class="p">]</span> <span class="o">==</span> <span class="s">'train'</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">data</span>


<span class="k">def</span> <span class="nf">custom_train_test_split</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">cutoff_day</span><span class="o">=</span><span class="mi">15</span><span class="p">):</span>
    <span class="n">train</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="n">data</span><span class="p">[</span><span class="s">'day'</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="n">cutoff_day</span><span class="p">]</span>
    <span class="n">test</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="n">data</span><span class="p">[</span><span class="s">'day'</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">cutoff_day</span><span class="p">]</span>
    
    <span class="k">return</span> <span class="n">train</span><span class="p">,</span> <span class="n">test</span>


<span class="k">def</span> <span class="nf">prep_data</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">input_cols</span><span class="p">):</span>
    <span class="n">X</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="n">input_cols</span><span class="p">]</span><span class="o">.</span><span class="n">as_matrix</span><span class="p">()</span>
    <span class="n">y_r</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s">'registered_log'</span><span class="p">]</span><span class="o">.</span><span class="n">as_matrix</span><span class="p">()</span>
    <span class="n">y_c</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s">'casual_log'</span><span class="p">]</span><span class="o">.</span><span class="n">as_matrix</span><span class="p">()</span>
    
    <span class="k">return</span> <span class="n">X</span><span class="p">,</span> <span class="n">y_r</span><span class="p">,</span> <span class="n">y_c</span>

    
<span class="k">def</span> <span class="nf">predict</span><span class="p">(</span><span class="n">input_cols</span><span class="p">,</span> <span class="n">model_params</span><span class="o">=</span><span class="p">{}):</span>
    <span class="n">data</span> <span class="o">=</span> <span class="n">get_data</span><span class="p">()</span>
    
    <span class="n">train</span><span class="p">,</span> <span class="n">test</span> <span class="o">=</span> <span class="n">custom_train_test_split</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
    
    <span class="n">X_train</span><span class="p">,</span> <span class="n">y_train_r</span><span class="p">,</span> <span class="n">y_train_c</span> <span class="o">=</span> <span class="n">prep_data</span><span class="p">(</span><span class="n">train</span><span class="p">,</span> <span class="n">input_cols</span><span class="p">)</span>
    <span class="n">X_test</span><span class="p">,</span> <span class="n">y_test_r</span><span class="p">,</span> <span class="n">y_test_c</span> <span class="o">=</span> <span class="n">prep_data</span><span class="p">(</span><span class="n">test</span><span class="p">,</span> <span class="n">input_cols</span><span class="p">)</span>

    <span class="n">model_params</span><span class="o">.</span><span class="n">update</span><span class="p">({</span>
        <span class="s">'n_jobs'</span><span class="p">:</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span>
        <span class="s">'random_state'</span><span class="p">:</span> <span class="mi">123</span><span class="p">,</span>
    <span class="p">})</span>
    <span class="n">model</span> <span class="o">=</span> <span class="n">RandomForestRegressor</span><span class="p">(</span><span class="o">**</span><span class="n">model_params</span><span class="p">)</span>
    
    <span class="n">model_r</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X_train</span><span class="p">,</span> <span class="n">y_train_r</span><span class="p">)</span>
    <span class="n">y_pred_r</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">model_r</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">X_test</span><span class="p">))</span> <span class="o">-</span> <span class="mi">1</span>
    
    <span class="n">model_c</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X_train</span><span class="p">,</span> <span class="n">y_train_c</span><span class="p">)</span>
    <span class="n">y_pred_c</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">model_c</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">X_test</span><span class="p">))</span> <span class="o">-</span> <span class="mi">1</span>

    <span class="n">y_pred_comb</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="nb">round</span><span class="p">(</span><span class="n">y_pred_r</span> <span class="o">+</span> <span class="n">y_pred_c</span><span class="p">)</span>
    <span class="n">y_pred_comb</span><span class="p">[</span><span class="n">y_pred_comb</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
    
    <span class="n">y_test_comb</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">y_test_r</span><span class="p">)</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">y_test_c</span><span class="p">)</span> <span class="o">-</span> <span class="mi">2</span>

    <span class="n">score</span> <span class="o">=</span> <span class="n">get_rmsle</span><span class="p">(</span><span class="n">y_pred_comb</span><span class="p">,</span> <span class="n">y_test_comb</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">score</span></code></pre></figure> <figure class="highlight"><pre><code class="language-python" data-lang="python"><span class="c"># now that we've set that up, we can quickly try out different </span>
<span class="c"># combinations of features and have a pretty good sense for how </span>
<span class="c"># it would perform if we made a submission with that model</span>

<span class="c"># for example, here's the RMSLE using the original input variables </span>
<span class="c"># (minus the datetime column)</span>
<span class="n">cols</span> <span class="o">=</span> <span class="p">[</span><span class="s">'weather'</span><span class="p">,</span> <span class="s">'temp'</span><span class="p">,</span> <span class="s">'atemp'</span><span class="p">,</span> <span class="s">'humidity'</span><span class="p">,</span> 
        <span class="s">'windspeed'</span><span class="p">,</span> <span class="s">'holiday'</span><span class="p">,</span> <span class="s">'workingday'</span><span class="p">,</span> <span class="s">'season'</span><span class="p">]</span>
<span class="k">print</span> <span class="n">predict</span><span class="p">(</span><span class="n">cols</span><span class="p">)</span>

<span class="c"># now let's add the hour variable</span>
<span class="n">cols</span> <span class="o">=</span> <span class="n">cols</span> <span class="o">+</span> <span class="p">[</span><span class="s">'hour'</span><span class="p">]</span>
<span class="k">print</span> <span class="n">predict</span><span class="p">(</span><span class="n">cols</span><span class="p">)</span>

<span class="c"># big improvement!</span></code></pre></figure> <div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>1.351102939
0.471594968034
</code></pre></div></div> <figure class="highlight"><pre><code class="language-python" data-lang="python"><span class="c"># let's try out a few more possibilities</span>

<span class="n">base_cols</span> <span class="o">=</span> <span class="p">[</span>
    <span class="s">'weather'</span><span class="p">,</span> <span class="s">'temp'</span><span class="p">,</span> <span class="s">'atemp'</span><span class="p">,</span> <span class="s">'humidity'</span><span class="p">,</span> <span class="s">'windspeed'</span><span class="p">,</span> 
    <span class="s">'holiday'</span><span class="p">,</span> <span class="s">'workingday'</span><span class="p">,</span> <span class="s">'season'</span>
<span class="p">]</span>

<span class="n">time_cols</span> <span class="o">=</span> <span class="p">[</span><span class="s">'hour'</span><span class="p">,</span> <span class="s">'dow'</span><span class="p">,</span> <span class="s">'year'</span><span class="p">,</span> <span class="s">'month'</span><span class="p">,</span> <span class="s">'weeks_since_start'</span><span class="p">,</span> <span class="s">'day'</span><span class="p">]</span>

<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">time_cols</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">):</span>
    <span class="n">new_cols</span> <span class="o">=</span> <span class="n">time_cols</span><span class="p">[:</span><span class="n">i</span><span class="p">]</span>
    <span class="n">all_cols</span> <span class="o">=</span> <span class="n">base_cols</span> <span class="o">+</span> <span class="n">new_cols</span>
    <span class="k">print</span> <span class="s">'cols: base_cols + {}</span><span class="se">\n</span><span class="s">rmse: {}</span><span class="se">\n</span><span class="s">'</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
        <span class="n">new_cols</span><span class="p">,</span> 
        <span class="n">predict</span><span class="p">(</span><span class="n">all_cols</span><span class="p">)</span>
    <span class="p">)</span></code></pre></figure> <div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>cols: base_cols + []
rmse: 1.351102939

cols: base_cols + ['hour']
rmse: 0.471594968034

cols: base_cols + ['hour', 'dow']
rmse: 0.455313354995

cols: base_cols + ['hour', 'dow', 'year']
rmse: 0.362092301557

cols: base_cols + ['hour', 'dow', 'year', 'month']
rmse: 0.334982551858

cols: base_cols + ['hour', 'dow', 'year', 'month', 'weeks_since_start']
rmse: 0.337482905295

cols: base_cols + ['hour', 'dow', 'year', 'month', 'weeks_since_start', 'day']
rmse: 0.342750167966
</code></pre></div></div> <figure class="highlight"><pre><code class="language-python" data-lang="python"><span class="c"># now, let's hold the feature set constant and tune the</span>
<span class="c"># model parameters to further improve accuracy</span>

<span class="c"># feature set</span>
<span class="n">x_cols</span> <span class="o">=</span> <span class="p">[</span>
    <span class="s">'weather'</span><span class="p">,</span> <span class="s">'temp'</span><span class="p">,</span> <span class="s">'atemp'</span><span class="p">,</span> <span class="s">'humidity'</span><span class="p">,</span> <span class="s">'windspeed'</span><span class="p">,</span> 
    <span class="s">'holiday'</span><span class="p">,</span> <span class="s">'workingday'</span><span class="p">,</span> <span class="s">'season'</span><span class="p">,</span> 
    <span class="s">'hour'</span><span class="p">,</span> <span class="s">'dow'</span><span class="p">,</span> <span class="s">'year'</span><span class="p">,</span>
<span class="p">]</span>

<span class="c"># random forest param grid</span>
<span class="n">n_estimators</span> <span class="o">=</span> <span class="p">[</span><span class="mi">500</span><span class="p">,</span> <span class="mi">1000</span><span class="p">,</span> <span class="mi">1500</span><span class="p">]</span>
<span class="n">min_samples_splits</span> <span class="o">=</span> <span class="p">[</span><span class="mi">6</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">12</span><span class="p">,</span> <span class="mi">14</span><span class="p">]</span>

<span class="n">best_score</span><span class="p">,</span> <span class="n">best_params</span> <span class="o">=</span> <span class="n">inf</span><span class="p">,</span> <span class="bp">None</span>

<span class="c"># loop through param grid &amp; find top performer</span>
<span class="k">for</span> <span class="n">ne</span> <span class="ow">in</span> <span class="n">n_estimators</span><span class="p">:</span>
    <span class="k">for</span> <span class="n">mss</span> <span class="ow">in</span> <span class="n">min_samples_splits</span><span class="p">:</span>
        <span class="n">params</span> <span class="o">=</span> <span class="p">{</span><span class="s">'n_estimators'</span><span class="p">:</span> <span class="n">ne</span><span class="p">,</span> <span class="s">'min_samples_split'</span><span class="p">:</span> <span class="n">mss</span><span class="p">}</span>
        <span class="n">score</span> <span class="o">=</span> <span class="n">predict</span><span class="p">(</span><span class="n">x_cols</span><span class="p">,</span> <span class="n">params</span><span class="p">)</span>
        <span class="k">print</span> <span class="s">'trees: {}, mss: {}, rmse: {}'</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">ne</span><span class="p">,</span> <span class="n">mss</span><span class="p">,</span> <span class="n">score</span><span class="p">)</span>
        
        <span class="k">if</span> <span class="n">score</span> <span class="o">&lt;</span> <span class="n">best_score</span><span class="p">:</span>
            <span class="n">best_params</span> <span class="o">=</span> <span class="n">params</span>
            <span class="n">best_score</span> <span class="o">=</span> <span class="n">score</span>
            
<span class="k">print</span> <span class="s">'best params: {}, rmse: {}'</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">best_params</span><span class="p">,</span> <span class="n">best_score</span><span class="p">)</span></code></pre></figure> <div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>trees: 500, mss: 6, rmse: 0.346277501816
trees: 500, mss: 8, rmse: 0.34516067175
trees: 500, mss: 10, rmse: 0.344992452172
trees: 500, mss: 12, rmse: 0.344630590643
trees: 500, mss: 14, rmse: 0.345382630487
trees: 1000, mss: 6, rmse: 0.346321699235
trees: 1000, mss: 8, rmse: 0.345137737679
trees: 1000, mss: 10, rmse: 0.344800789859
trees: 1000, mss: 12, rmse: 0.344309234546
trees: 1000, mss: 14, rmse: 0.345338741363
trees: 1500, mss: 6, rmse: 0.346564275074
trees: 1500, mss: 8, rmse: 0.345270886888
trees: 1500, mss: 10, rmse: 0.345261507783
trees: 1500, mss: 12, rmse: 0.344792046338
trees: 1500, mss: 14, rmse: 0.344961343139
best params: {'n_estimators': 1000, 'min_samples_split': 12, 'random_state': 123, 'n_jobs': -1}, rmse: 0.344309234546
</code></pre></div></div> <figure class="highlight"><pre><code class="language-python" data-lang="python"><span class="c"># putting it all together</span>

<span class="c"># features (performs better on leaderboard w/o month var)</span>
<span class="n">x_cols</span> <span class="o">=</span> <span class="p">[</span>
    <span class="s">'weather'</span><span class="p">,</span> <span class="s">'temp'</span><span class="p">,</span> <span class="s">'atemp'</span><span class="p">,</span> <span class="s">'humidity'</span><span class="p">,</span> <span class="s">'windspeed'</span><span class="p">,</span> 
    <span class="s">'holiday'</span><span class="p">,</span> <span class="s">'workingday'</span><span class="p">,</span> <span class="s">'season'</span><span class="p">,</span> 
    <span class="s">'hour'</span><span class="p">,</span> <span class="s">'dow'</span><span class="p">,</span> <span class="s">'year'</span>
<span class="p">]</span>

<span class="c"># prepare training set</span>
<span class="n">df_train</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">df</span><span class="p">[</span><span class="s">'_data'</span><span class="p">]</span> <span class="o">==</span> <span class="s">'train'</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
<span class="n">X_train</span> <span class="o">=</span> <span class="n">df_train</span><span class="p">[</span><span class="n">x_cols</span><span class="p">]</span><span class="o">.</span><span class="n">as_matrix</span><span class="p">()</span>
<span class="n">y_train_cas</span> <span class="o">=</span> <span class="n">df_train</span><span class="p">[</span><span class="s">'casual_log'</span><span class="p">]</span><span class="o">.</span><span class="n">as_matrix</span><span class="p">()</span>
<span class="n">y_train_reg</span> <span class="o">=</span> <span class="n">df_train</span><span class="p">[</span><span class="s">'registered_log'</span><span class="p">]</span><span class="o">.</span><span class="n">as_matrix</span><span class="p">()</span>

<span class="c"># prepare test set</span>
<span class="n">df_test</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">df</span><span class="p">[</span><span class="s">'_data'</span><span class="p">]</span> <span class="o">==</span> <span class="s">'test'</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
<span class="n">X_test</span> <span class="o">=</span> <span class="n">df_test</span><span class="p">[</span><span class="n">x_cols</span><span class="p">]</span><span class="o">.</span><span class="n">as_matrix</span><span class="p">()</span>

<span class="c"># fit on training set</span>
<span class="n">model</span> <span class="o">=</span> <span class="n">RandomForestRegressor</span><span class="p">(</span>
    <span class="n">n_estimators</span> <span class="o">=</span> <span class="mi">1000</span><span class="p">,</span> 
    <span class="n">min_samples_split</span> <span class="o">=</span> <span class="mi">12</span><span class="p">,</span> 
    <span class="n">n_jobs</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span>
    <span class="n">random_state</span> <span class="o">=</span> <span class="mi">123456</span><span class="p">,</span> 
<span class="p">)</span>

<span class="c"># predict on test set &amp; transform output back from log scale</span>
<span class="n">casual_model</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X_train</span><span class="p">,</span> <span class="n">y_train_cas</span><span class="p">)</span>
<span class="n">y_pred_cas</span> <span class="o">=</span> <span class="n">casual_model</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">X_test</span><span class="p">)</span>
<span class="n">y_pred_cas</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">y_pred_cas</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span>

<span class="n">registered_model</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X_train</span><span class="p">,</span> <span class="n">y_train_reg</span><span class="p">)</span>
<span class="n">y_pred_reg</span> <span class="o">=</span> <span class="n">registered_model</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">X_test</span><span class="p">)</span>
<span class="n">y_pred_reg</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">y_pred_reg</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span>

<span class="c"># add casual &amp; registered predictions together</span>
<span class="n">df_test</span><span class="p">[</span><span class="s">'count'</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="nb">round</span><span class="p">(</span><span class="n">y_pred_cas</span> <span class="o">+</span> <span class="n">y_pred_reg</span><span class="p">)</span>

<span class="c"># output predictions for submission</span>
<span class="n">final_df</span> <span class="o">=</span> <span class="n">df_test</span><span class="p">[[</span><span class="s">'datetime'</span><span class="p">,</span> <span class="s">'count'</span><span class="p">]]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
<span class="n">final_df</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="s">'../output/predicted.csv'</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
<span class="k">print</span> <span class="s">'boom.'</span></code></pre></figure> <div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>boom.
</code></pre></div></div> </article> </div> </div> <footer class='p1 center'> <img class='align-middle' src='/assets/img/misc/peace.gif' width='30'> </footer> <script type="text/javascript"> var _gaq = _gaq || []; _gaq.push(['_setAccount', 'UA-37353161-5']); _gaq.push(['_trackPageview']); (function() { var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true; ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js'; var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s); })(); </script> </body> </html>